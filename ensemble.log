INFO:sccl.data.column_config:Auto-detected study column: 'Study'
INFO:sccl.data.column_config:Auto-detected cell type column: 'Cell Type'
INFO:sccl.data.preprocessing:Starting subset. Initial: 748679 cells
INFO:sccl.data.preprocessing:Using study column: 'Study'
INFO:sccl.data.preprocessing:Filter 'Study': 23344 cells match
INFO:sccl.data.preprocessing:After obs filter: 23344 cells
INFO:sccl.data.preprocessing:Final: 23344 cells x 39075 genes
INFO:sccl.data.preprocessing:Starting subset. Initial: 748679 cells
INFO:sccl.data.preprocessing:Using study column: 'Study'
INFO:sccl.data.preprocessing:Filter 'Study': 4191 cells match
INFO:sccl.data.preprocessing:After obs filter: 4191 cells
INFO:sccl.data.preprocessing:Final: 4191 cells x 39075 genes
INFO:sccl.models.celltypist:CellTypist loaded successfully
INFO:sccl.models.celltypist:Training CellTypist model...
INFO:sccl.models.celltypist:Normalizing and log-transforming data...
INFO:sccl.models.celltypist:Training on 15,000 cells...
INFO:celltypist.logger:üç≥ Preparing data before training
INFO:celltypist.logger:‚úÇÔ∏è 18957 non-expressed genes are filtered out
INFO:celltypist.logger:üî¨ Input data has 15000 cells and 20118 genes
INFO:celltypist.logger:‚öñÔ∏è Scaling input data
INFO:celltypist.logger:üèãÔ∏è Training data using SGD logistic regression
INFO:celltypist.logger:üîé Selecting features
INFO:celltypist.logger:üß¨ 2903 features are selected
INFO:celltypist.logger:üèãÔ∏è Starting the second round of training
INFO:celltypist.logger:üèãÔ∏è Training data using logistic regression
================================================================================
Comprehensive Cell Type Annotation Benchmark
================================================================================

Methods:
  - CellTypist (reference-based): True
  - SCimilarity + Ensemble:       True
  - SingleR (reference-based):    True
  - scTab (zero-shot):            True

Loading data...

================================================================================
Cross-Platform: van_galen (Seq-Well) -> Velten (Muta-seq)
================================================================================
  Reference: 15,000 cells
  Query:     4,191 cells

  [CellTypist]... INFO:celltypist.logger:‚úÖ Model training done!
INFO:sccl.models.celltypist:‚úì CellTypist model trained
INFO:sccl.models.celltypist:Running CellTypist with model: Immune_All_Low.pkl
INFO:sccl.models.celltypist:Normalizing and log-transforming data...
INFO:sccl.models.celltypist:Using custom trained model
INFO:sccl.models.celltypist:Predicting cell types...
INFO:celltypist.logger:üî¨ Input data has 4191 cells and 39075 genes
INFO:celltypist.logger:üîó Matching reference genes in the model
INFO:celltypist.logger:üß¨ 2903 features used for prediction
INFO:celltypist.logger:‚öñÔ∏è Scaling input data
INFO:celltypist.logger:üñãÔ∏è Predicting labels
INFO:celltypist.logger:‚úÖ Prediction done!
INFO:celltypist.logger:üëÄ Can not detect a neighborhood graph, will construct one before the over-clustering
INFO:celltypist.logger:‚õìÔ∏è Over-clustering input data with resolution set to 5
INFO:celltypist.logger:üó≥Ô∏è Majority voting the predictions
INFO:celltypist.logger:‚úÖ Majority voting done!
Acc: 0.804, ARI: 0.663, Time: 55.0s

  [SingleR]...     Common genes: 39075
Acc: 0.562, ARI: 0.452, Time: 142.3s

  [scTab]...     Gene overlap: 17492/19331
    scTab inference:   0%|          | 0/3 [00:00<?, ?it/s]    scTab inference:  33%|‚ñà‚ñà‚ñà‚ñé      | 1/3 [00:00<00:00,  4.76it/s]    scTab inference: 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 3/3 [00:00<00:00, 10.82it/s]    scTab inference: 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 3/3 [00:00<00:00,  9.59it/s]
INFO:sccl.data.preprocessing:Starting preprocessing...
INFO:sccl.data.preprocessing:Initial: 15000 cells x 39075 genes
INFO:sccl.data.preprocessing:After filtering: 15000 cells x 18972 genes
INFO:sccl.data.preprocessing:Normalizing counts...
INFO:sccl.data.preprocessing:Selecting 2000 highly variable genes...
INFO:sccl.data.preprocessing:Selected 2000 HVGs
INFO:sccl.data.preprocessing:Scaling data...
INFO:sccl.data.preprocessing:Computing PCA...
INFO:sccl.data.preprocessing:Preprocessing completed
INFO:sccl.data.preprocessing:Starting preprocessing...
INFO:sccl.data.preprocessing:Initial: 4191 cells x 39075 genes
INFO:sccl.data.preprocessing:After filtering: 4191 cells x 23472 genes
INFO:sccl.data.preprocessing:Normalizing counts...
INFO:sccl.data.preprocessing:Selecting 2000 highly variable genes...
INFO:sccl.data.preprocessing:Selected 2000 HVGs
INFO:sccl.data.preprocessing:Scaling data...
INFO:sccl.data.preprocessing:Computing PCA...
INFO:sccl.data.preprocessing:Preprocessing completed
INFO:sccl.pipeline:Initialized pipeline with model: scimilarity
INFO:sccl.models.scimilarity:SCimilarity loaded successfully
INFO:sccl.models.scimilarity:Computing SCimilarity embeddings...
INFO:sccl.models.scimilarity:Loading SCimilarity CellAnnotation model (species: human)...
INFO:sccl.models.scimilarity:Using gene order with 28231 genes
INFO:sccl.pipeline:Initialized pipeline with model: scimilarity
INFO:sccl.models.scimilarity:SCimilarity loaded successfully
INFO:sccl.models.scimilarity:Computing SCimilarity embeddings...
INFO:sccl.models.scimilarity:Loading SCimilarity CellAnnotation model (species: human)...
INFO:sccl.models.scimilarity:Using gene order with 28231 genes
/home/daniilf/miniconda3/envs/aml/lib/python3.10/site-packages/sklearn/neural_network/_multilayer_perceptron.py:686: ConvergenceWarning: Stochastic Optimizer: Maximum iterations (300) reached and the optimization hasn't converged yet.
  warnings.warn(
Acc: 0.267, ARI: 0.060, Time: 8.2s

  Computing SCimilarity embeddings...

  Individual Classifiers:
    [knn]... Acc: 0.814
    [logreg]... Acc: 0.850
    [rf]... Acc: 0.793
    [mlp]... Acc: 0.856
  [Ensemble-SoftVoting]... Acc: 0.853

================================================================================
FINAL RESULTS
================================================================================

Cross-Platform: van_galen (Seq-Well) -> Velten (Muta-seq):
              method            type  accuracy      ari   time_sec
     SCimilarity-mlp embedding-based  0.855643 0.745280  19.831692
SCimilarity-Ensemble embedding-based  0.853257 0.739514   9.796796
  SCimilarity-logreg embedding-based  0.849678 0.732968   2.001604
     SCimilarity-knn embedding-based  0.814126 0.663183   0.189436
          CellTypist reference-based  0.803627 0.662926  54.959894
      SCimilarity-rf embedding-based  0.792651 0.627648   0.400669
             SingleR reference-based  0.561918 0.451914 142.319156
               scTab       zero-shot  0.266524 0.059538   8.174812

Results saved to: /home/daniilf/aml-batch-correction/experiments/paper/results/comprehensive_benchmark_results.csv
